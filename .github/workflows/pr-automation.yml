name: PR Automation

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  auto-label:
    name: ğŸ·ï¸ Auto Label PR
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'synchronize'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Label based on files changed
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  calculate-size:
    name: ğŸ“ Calculate PR Size
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'synchronize'

    steps:
      - name: ğŸ“ Add size label
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: 10
          s_label: 'size/s'
          s_max_size: 100
          m_label: 'size/m'
          m_max_size: 500
          l_label: 'size/l'
          l_max_size: 1000
          xl_label: 'size/xl'

  welcome-comment:
    name: ğŸ‘‹ Welcome Comment
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'

    steps:
      - name: ğŸ’¬ Add welcome comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Only comment if no bot comments exist yet
            const botComment = comments.find(comment => comment.user.type === 'Bot');
            if (!botComment) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ‘‹ Thanks for opening this PR!\n\n` +
                      `âš¡ **The CI/CD pipeline will run automatically.**\n\n` +
                      `### ğŸ“‹ Pre-merge Checklist\n` +
                      `Please ensure:\n` +
                      `- âœ… All tests pass\n` +
                      `- âœ… Code is properly formatted\n` +
                      `- âœ… No linting errors\n` +
                      `- âœ… No security vulnerabilities introduced\n` +
                      `- âœ… PR description clearly explains changes\n\n` +
                      `### ğŸ¤– Automated Checks\n` +
                      `The following checks will run:\n` +
                      `- ğŸ” **Linting** - ESLint & Prettier\n` +
                      `- ğŸ§ª **Testing** - Unit & Integration tests\n` +
                      `- ğŸ—ï¸ **Build** - Production build verification\n` +
                      `- ğŸ”’ **Security** - Dependency & vulnerability scanning\n\n` +
                      `The build status will be updated here shortly. Good luck! ğŸš€`
              });
            }

  check-conventional-commits:
    name: ğŸ“ Check Commit Messages
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'synchronize'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Validate commit messages
        run: |
          echo "ğŸ” Checking commit message format..."

          # Get commits in this PR
          COMMITS=$(git log --format=%s ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})

          # Check if commits follow conventional format (feat:, fix:, docs:, etc.)
          INVALID_COMMITS=""
          while IFS= read -r commit; do
            if ! echo "$commit" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+"; then
              INVALID_COMMITS="$INVALID_COMMITS\n- $commit"
            fi
          done <<< "$COMMITS"

          if [ -n "$INVALID_COMMITS" ]; then
            echo "âš ï¸ Some commits don't follow conventional commit format:"
            echo -e "$INVALID_COMMITS"
            echo ""
            echo "â„¹ï¸ Consider using conventional commits: feat:, fix:, docs:, etc."
            echo "This won't fail the build, but it's recommended for better changelog generation."
          else
            echo "âœ… All commits follow conventional format!"
          fi
        continue-on-error: true

  pr-status:
    name: ğŸ“Š PR Status Summary
    runs-on: ubuntu-latest
    needs: [auto-label, calculate-size, welcome-comment, check-conventional-commits]
    if: always() && (github.event.action == 'opened' || github.event.action == 'synchronize')

    steps:
      - name: ğŸ“Š Summary
        run: |
          echo "================================================"
          echo "           PR AUTOMATION COMPLETED"
          echo "================================================"
          echo ""
          echo "Auto Label:      ${{ needs.auto-label.result }}"
          echo "Size Calculation: ${{ needs.calculate-size.result }}"
          echo "Welcome Comment:  ${{ needs.welcome-comment.result }}"
          echo "Commit Check:     ${{ needs.check-conventional-commits.result }}"
          echo ""
          echo "âœ… PR automation tasks completed!"
          echo "================================================"
