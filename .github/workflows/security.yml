name: Security Scanning

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run security scans every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  codeql-backend:
    name: ğŸ” CodeQL - Backend
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-extended,security-and-quality
          config: |
            paths:
              - sopwriter-backend/src

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ“Š Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: /language:javascript-typescript/backend

  codeql-frontend:
    name: ğŸ” CodeQL - Frontend
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-extended,security-and-quality
          config: |
            paths:
              - sopwriter-frontend/src

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ“Š Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: /language:javascript-typescript/frontend

  dependency-scan:
    name: ğŸ” Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” Audit Backend Dependencies
        working-directory: ./sopwriter-backend
        run: |
          echo "ğŸ” Scanning backend dependencies..."
          npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilities found in backend"
        continue-on-error: true

      - name: ğŸ” Audit Frontend Dependencies
        working-directory: ./sopwriter-frontend
        run: |
          echo "ğŸ” Scanning frontend dependencies..."
          npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilities found in frontend"
        continue-on-error: true

  secret-scan:
    name: ğŸ” Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better secret detection

      - name: ğŸ” Run TruffleHog for Secret Detection
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified --fail
        continue-on-error: true

  security-summary:
    name: ğŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [codeql-backend, codeql-frontend, dependency-scan, secret-scan]
    if: always()

    steps:
      - name: ğŸ“Š Generate Security Report
        run: |
          echo "================================================"
          echo "         SECURITY SCANNING RESULTS"
          echo "================================================"
          echo ""
          echo "CodeQL Backend:      ${{ needs.codeql-backend.result }}"
          echo "CodeQL Frontend:     ${{ needs.codeql-frontend.result }}"
          echo "Dependency Scan:     ${{ needs.dependency-scan.result }}"
          echo "Secret Scan:         ${{ needs.secret-scan.result }}"
          echo ""
          echo "âœ… Security scan completed!"
          echo "Review results in the Security tab"
          echo "================================================"
